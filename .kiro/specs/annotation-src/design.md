# Design Document

## Overview

本设计文档描述如何对 mini-vue 的 `src` 目录下的 TypeScript 源码注释进行**校正与更新**。代码经过多次迭代后，部分注释已无法与当前逻辑匹配，主要问题包括：

- 函数签名/参数/返回值变更后，注释未同步更新
- 控制流/分支逻辑重构后，注释描述的行为与实际不符
- 变量名/函数名重命名后，注释中的引用已过时
- 部分关键逻辑仍缺少必要的注释

目标是在**不改动任何业务逻辑**的前提下，**校正过时注释、补充缺失注释**，确保所有注释准确反映代码的真实行为。

## Architecture

### 执行流程

注释更新采用「目录分批」策略，按 `src` 一级子目录逐步推进：

```
┌─────────────────────────────────────────────────────────────┐
│                    注释更新执行流程                           │
├─────────────────────────────────────────────────────────────┤
│  Phase 0: 准备与对齐                                         │
│    ├── 读取注释风格示例                                       │
│    └── 建立目录级文件清单                                     │
│                                                             │
│  Phase 1: 按目录更新注释                                     │
│    ├── jsx-foundation → jsx-runtime → messages              │
│    ├── reactivity → router                                  │
│    └── runtime-core → runtime-dom → shared                  │
│                                                             │
│  Phase 2: 抽样复核与验证                                     │
│    ├── 抽样复核（每目录至少 1 个核心文件）                     │
│    └── 运行相关测试                                          │
└─────────────────────────────────────────────────────────────┘
```

### 每个目录任务的固定步骤

1. **读取目标目录上下文**：先从 `index.ts` 与最核心的入口文件开始，构建调用链
2. **生成目标文件清单**：在任务输入中显式列出要修改的文件路径
3. **逐文件校正注释**：
   - 识别过时注释（与当前逻辑不匹配）
   - 更新过时注释以匹配真实行为
   - 补充缺失的关键注释
4. **最小验证**：优先跑与改动域相关的测试

## Components and Interfaces

### 注释更新策略

#### 过时注释识别标准

| 类型       | 识别方式                                            |
| ---------- | --------------------------------------------------- |
| 签名不匹配 | 注释描述的参数/返回值与当前函数签名不一致           |
| 逻辑不匹配 | 注释描述的行为/分支与当前代码执行路径不一致         |
| 引用过时   | 注释中引用的变量名/函数名在代码中已不存在或已重命名 |
| 上下文失效 | 注释描述的前置条件/依赖关系已变更                   |

#### 注释写什么（意图优先）

注释应回答「为什么/为了什么/依赖什么/边界是什么」，而不是复述代码表面语义：

| 类别     | 说明                                 |
| -------- | ------------------------------------ |
| 职责     | 函数/类型/类的目的与对外可见行为     |
| 假设     | 输入约束、依赖前置条件、不变量       |
| 调用关系 | 与上层/下层函数的连接点，数据流方向  |
| 策略     | 分支选择原因、循环处理策略、回退路径 |

#### 注释放哪里（结构化覆盖）

- **所有函数**（全局函数、类方法、对象字面量函数）在声明前必须有职责注释
- **所有 interface** 及其属性都必须有前置注释
- **所有类的属性**（实例/静态/getter/setter）必须有前置注释
- **函数体内部**：关键分支/循环/需要推理的语句块必须在代码块上方写明目的与策略

#### 注释形态（推荐用法）

| 场景                           | 推荐形式             |
| ------------------------------ | -------------------- |
| 导出函数 / 重要类型 / 大逻辑块 | `/** ... */`（多行） |
| 函数体内部解释策略             | `/* ... */` 单段说明 |
| 简单概述                       | `// ...` 单行        |

#### 约束

- 禁止同一段代码上方堆叠多个块注释；需要补充信息时应合并为一个注释
- 已有注释准确则不修改；若不准确，**必须修正**以贴合真实逻辑
- **禁止行尾注释**
- **语言必须为中文**

### 目录级关注点

| 目录                    | 重点关注                                                               |
| ----------------------- | ---------------------------------------------------------------------- |
| `src/reactivity/**`     | 响应式依赖追踪/触发、effect 生命周期、ref/computed/watch 的时序与清理  |
| `src/runtime-core/**`   | VirtualNode/组件实例、mount/patch 流程、错误处理与边界                 |
| `src/runtime-dom/**`    | 宿主实现细节（DOM 属性/事件/类名合并），与 runtime-core options 的契约 |
| `src/jsx-foundation/**` | VirtualNode 工厂、children 归一化、与 JSX runtime 的边界               |
| `src/jsx-runtime/**`    | `jsx/jsxs/jsxDEV/h` 等封装的语义差异与开发态处理                       |
| `src/router/**`         | 路径归一化、导航状态、`RouterLink/RouterView` 的渲染时机与依赖         |
| `src/shared/**`         | 跨域工具、错误通道、环境检测与注入机制                                 |
| `src/messages/**`       | 错误/警告文案的组织方式与对外导出约束                                  |

## Data Models

本 spec 不涉及数据模型变更，仅对现有源码添加注释。

## Correctness Properties

_A property is a characteristic or behavior that should hold true across all valid executions of a system—essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees._

本 spec 的工作性质为「文档/注释补全」，不涉及可执行代码的功能实现，因此不适用 Property-Based Testing。

验证方式改为人工复核 Checklist：

1. 注释是否解释了意图/边界而非复述代码？
2. 是否存在遗漏的关键分支/循环说明？（遗漏视为失败）
3. 是否引入了任何逻辑改动、格式扰动（大量空行/重排）？
4. 是否出现行尾注释？
5. 是否出现非中文注释？

## Error Handling

### 任务失败条件

- 修改了未被点名的文件
- 改变了业务逻辑、函数签名或执行路径
- 遗漏了任何需要读者思考才能理解的语句块的注释
- 保留了与当前逻辑不匹配的过时注释
- 使用了行尾注释
- 使用了非中文注释

### 恢复策略

- 使用 Git 回滚到任务开始前的状态
- 重新执行任务，确保遵循约束

## Testing Strategy

### 验证方式

由于本 spec 不涉及功能代码实现，采用以下验证方式：

1. **人工复核**：按 Checklist 抽样检查每个目录至少 1 个核心文件
2. **相关测试**：按目录选择对应 `test/<domain>/**` 运行，确保注释改动未误触代码结构

### 测试命令

```bash
# 按目录运行相关测试
pnpm run test -- test/reactivity/**
pnpm run test -- test/runtime-core/**
pnpm run test -- test/runtime-dom/**
# ... 其他目录类似
```

### 复核 Checklist

- [ ] 无行尾注释
- [ ] 全部使用中文
- [ ] 无逻辑变更
- [ ] 关键分支/循环无遗漏
- [ ] 不堆叠块注释
- [ ] 无过时注释（注释与代码逻辑匹配）
