# Src 代码注释补全 — Design

## 1. 背景与目标

mini-vue 的核心实现分布在 `src` 的多个子域中（reactivity/runtime-core/runtime-dom/jsx/router/shared 等）。当前阅读成本主要来自：

- 关键函数/类型缺少职责说明，读者需要在调用链中跳转理解。
- 分支/循环的策略性代码块缺少意图解释，容易误读边界与假设。

本 spec 的目标是在**不改动任何业务逻辑**的前提下，为 `src` 下的代码补充**中文、逻辑导向、前置**注释，使读者能更快理解模块职责与关键控制流。

## 2. 范围与约束

### 2.1 修改范围

- 仅对 `src/**` 内的 TypeScript 源码增加/修正注释。
- 优先覆盖：对外导出 API、核心算法/调度、边界处理、错误处理通道、平台无关/宿主 glue 的连接点。

### 2.2 强约束（必须遵守）

本 spec 完全对齐 `.github/prompts/annotation.prompt.md` 的规则：

- **只允许前置注释**：允许 `/** ... */`、`/* ... */`、`// ...`，但都必须位于相关代码行之上；**禁止行尾注释**。
- **语言必须为中文**。
- **不得改动逻辑**：不改函数签名、不改执行路径、不调整语句顺序（除非插入注释必须微调空行，但应尽量保持原结构）。
- **只在被点名的文件内修改**：执行每个任务时，需要在任务输入中明确文件列表；未被点名的文件不得修改。
- **先读示例再动笔**：每个任务开始前必须先阅读仓库内已有注释风格示例（至少包含：`src/runtime-core/create-app.ts`、`src/runtime-core/renderer.ts`）。

> 说明：上面「只在被点名文件内修改」是为了与注释 agent 的执行约束一致。本文档定义的是工作方式：按目录分批点名文件并逐步完成。

## 3. 注释风格与写作准则

### 3.1 注释写什么（意图优先）

注释应回答「为什么/为了什么/依赖什么/边界是什么」，而不是复述代码表面语义。

- 职责：函数/类型/类的目的与对外可见行为
- 假设：输入约束、依赖前置条件、不变量
- 调用关系：与上层/下层函数的连接点，数据流方向
- 策略：分支选择原因、循环处理策略、回退路径

### 3.2 注释放哪里（结构化覆盖）

- **所有函数**（全局函数、类方法、对象字面量函数）在声明前必须有职责注释。
- **所有 interface** 及其属性都必须有前置注释。
- **所有类的属性**（实例/静态/getter/setter）必须有前置注释。
- **函数体内部**：关键分支/循环/需要推理的语句块必须在代码块上方写明目的与策略。

### 3.3 注释形态（推荐用法）

- 导出函数 / 重要类型 / 大逻辑块：优先使用 `/** ... */`（多行）。
- 函数体内部解释策略：使用 `/* ... */` 单段说明。
- 简单概述：可以用 `// ...` 单行。

约束：

- 禁止同一段代码上方堆叠多个块注释；需要补充信息时应合并为一个注释。
- 已有注释清晰则不重复；若不准确，允许**修改**以贴合真实逻辑。

## 4. 执行流程（目录分批）

### 4.1 每个目录任务的固定步骤

1. **读取注释风格示例**：`src/runtime-core/create-app.ts`、`src/runtime-core/renderer.ts`。
2. **读取目标目录上下文**：先从 `index.ts` 与最核心的入口文件开始，构建调用链。
3. **生成目标文件清单**：在任务输入中显式列出要修改的文件路径（符合「只改被点名文件」的约束）。
4. **逐文件补注释**：按「导出 API → 核心逻辑 → 工具函数/类型」顺序推进。
5. **最小验证**：如仓库已有测试，优先跑与改动域相关的测试（例如 `test/runtime-core/**`）。

### 4.2 质量门槛（Review Checklist）

- 注释是否解释了意图/边界而非复述代码？
- 是否存在遗漏的关键分支/循环说明？（遗漏视为失败）
- 是否引入了任何逻辑改动、格式扰动（大量空行/重排）？
- 是否出现行尾注释？是否出现非中文注释？

## 5. 目录级关注点（写注释时的「重点提示」）

- `src/reactivity/**`：响应式依赖追踪/触发、effect 生命周期、ref/computed/watch 的时序与清理。
- `src/runtime-core/**`：VNode/组件实例、mount/patch 流程、错误处理与边界。
- `src/runtime-dom/**`：宿主实现细节（DOM 属性/事件/类名合并），与 runtime-core options 的契约。
- `src/jsx-foundation/**`：VNode 工厂、children 归一化、与 JSX runtime 的边界。
- `src/jsx-runtime/**`：`jsx/jsxs/jsxDEV/h` 等封装的语义差异与开发态处理。
- `src/router/**`：路径归一化、导航状态、`RouterLink/RouterView` 的渲染时机与依赖。
- `src/shared/**`：跨域工具、错误通道、环境检测与注入机制。
- `src/messages/**`：错误/警告文案的组织方式与对外导出约束。
